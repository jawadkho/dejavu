version: "3"
services:
    db:
      env_file: .env
      image: mysql
      container_name: ${MYSQL_CONTAINER_NAME}
      environment:
        - MYSQL_ALLOW_EMPTY_PASSWORD=yes
      networks:
        - db-backend
    db-setup:
      env_file: .env
      image: mysql
      container_name: ${MYSQL_CONTAINER_NAME}-setup
      command: >
        sh -c '
        while ! mysqladmin ping -h"db" --silent; do echo "Waiting for MySQL service"; sleep 1; done;
        echo "Creating database '${DATABASE_NAME}'";
        exec mysql -h"db" -uroot -e "CREATE DATABASE IF NOT EXISTS ${DATABASE_NAME}"';
      networks:
        - db-backend
      depends_on:
        - db
    dejavu:
      container_name: dejavu
      image: dejavu
      volumes:
        - ../:/dejavu
      build:
        context: ./
        args:
          http_proxy: ${http_proxy}
          https_proxy: ${https_proxy}
      networks:
        - db-backend
      depends_on:
        - db
        - db-setup
networks:
  db-backend: